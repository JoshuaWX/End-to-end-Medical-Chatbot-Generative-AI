<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>MedGuard Health Chatbot</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link rel="stylesheet" href="/dist/output.css">
<style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
        }
    </style>
<style>
    .mg-typing-dot {
        display: inline-block;
        width: 0.45rem;
        height: 0.45rem;
        border-radius: 9999px;
        animation: mg-typing-bounce 1.1s infinite ease-in-out;
    }

    .mg-typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .mg-typing-dot:nth-child(3) { animation-delay: 0.30s; }

    @keyframes mg-typing-bounce {
        0%, 80%, 100% { transform: translateY(0); opacity: 0.45; }
        40% { transform: translateY(-3px); opacity: 1; }
    }
</style>
<style>
    /* CSS-backed alignment so chat layout still works even if Tailwind content scanning misses new classes. */
    .mg-row { display: flex; width: 100%; gap: 0.75rem; align-items: flex-start; }
    .mg-row-bot { justify-content: flex-start; }
    .mg-row-user { justify-content: flex-end; }

    .mg-col { display: flex; flex-direction: column; max-width: 80%; }
    .mg-col-bot { align-items: flex-start; }
    .mg-col-user { align-items: flex-end; }
</style>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="flex flex-col h-screen max-w-md mx-auto bg-gradient-to-b from-primary/10 to-background-light dark:from-primary/20 dark:to-background-dark">
<header class="flex items-center justify-between p-4 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm border-b border-primary/20 dark:border-primary/30">
<button id="btn-back" type="button" aria-label="Go back" title="Go back" class="text-gray-700 dark:text-gray-300">
<span class="material-symbols-outlined">arrow_back_ios_new</span>
</button>
<div class="flex items-center gap-3">
<div class="relative">
<img alt="AI Assistant Avatar" class="w-10 h-10 rounded-full" src="https://lh3.googleusercontent.com/aida-public/AB6AXuD58a5UD08npEzMAZTBkCnx6s4GlnRgrDf96QEQVAYKZV209SCbDIETlwjlhZ9tfYzjefwyPsqoGvgIAY4zKFzaf_EuNu4nSu3WlGzP1ElF7dsYolWXKiaXm05S3lbDB_r-pTyMfo3OCVEQ-WH4zNMRPyAkCpEutWmfVmLNHBpXtL8FyP0zy7tgwTqHG5qxFpF_yG9W15ax70rkI2UvyzSOQm4Jvm6i2tL5NTu3jI4ny_4joMPeiaR842tMldIOW1ZVbRTFjWBM4SY"/>
<span class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full bg-green-500 border-2 border-background-light dark:border-background-dark"></span>
</div>
<div class="text-left">
<h1 class="text-base font-bold text-gray-900 dark:text-white">AI Health Chatbot</h1>
<p class="text-xs text-green-500">Online</p>
</div>
</div>
<button class="text-gray-700 dark:text-gray-300">
<span class="material-symbols-outlined">more_vert</span>
</button>
</header>
<main id="chat-log" class="flex-1 overflow-y-auto p-4 space-y-6">
    <div class="mg-row mg-row-bot">
        <img alt="AI Assistant Avatar" class="w-8 h-8 rounded-full" src="https://lh3.googleusercontent.com/aida-public/AB6AXuD58a5UD08npEzMAZTBkCnx6s4GlnRgrDf96QEQVAYKZV209SCbDIETlwjlhZ9tfYzjefwyPsqoGvgIAY4zKFzaf_EuNu4nSu3WlGzP1ElF7dsYolWXKiaXm05S3lbDB_r-pTyMfo3OCVEQ-WH4zNMRPyAkCpEutWmfVmLNHBpXtL8FyP0zy7tgwTqHG5qxFpF_yG9W15ax70rkI2UvyzSOQm4Jvm6i2tL5NTu3jI4ny_4joMPeiaR842tMldIOW1ZVbRTFjWBM4SY"/>
        <div class="mg-col mg-col-bot">
            <div class="bg-primary/10 dark:bg-primary/20 p-3 rounded-lg rounded-tl-none">
                <p class="text-sm text-gray-800 dark:text-gray-200">{{ greeting }}</p>
            </div>
        </div>
    </div>
</main>
<footer class="bg-background-light dark:bg-background-dark p-4 border-t border-primary/20 dark:border-primary/30">
<div class="flex items-center gap-3">
<div class="flex-1 relative">
<input id="chat-input" class="w-full bg-primary/10 dark:bg-primary/20 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 border-2 border-transparent focus:border-primary rounded-full py-2.5 pl-4 pr-12 text-sm focus:outline-none focus:ring-0 transition-colors" placeholder="Describe your symptoms..." type="text" autocomplete="off"/>
<button class="absolute inset-y-0 right-0 flex items-center justify-center px-3 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors">
<span class="material-symbols-outlined">mic</span>
</button>
</div>
<button id="chat-send" class="bg-primary text-white rounded-full p-3 flex-shrink-0 hover:bg-primary/90 transition-colors" aria-label="Send message" type="button">
<span class="material-symbols-outlined">send</span>
</button>
</div>
</footer>
</div>

</body></html>
<script>
    // Keep the editor/JS parser happy by keeping Jinja output inside a string.
    (function () {
        var metaJson = '{{ (meta or {}) | tojson }}';
        try {
            window.MEDGUARD_META = JSON.parse(metaJson);
        } catch (_) {
            window.MEDGUARD_META = {};
        }
    })();
</script>
<script>
    // Enable back navigation from the top-left arrow
    document.addEventListener('DOMContentLoaded', function () {
        var back = document.getElementById('btn-back');
        if (back) {
            back.addEventListener('click', function (e) {
                e.preventDefault();
                if (window.history && window.history.length > 1) {
                    window.history.back();
                } else {
                                        // Fallback if there's no history (direct navigation)
                                        // Prefer returning to the MedGuard UI (Vite dev server) when coming from there.
                                        try {
                                            if (document.referrer) {
                                                var refUrl = new URL(document.referrer);
                                                // If the referrer looks like the MedGuard dev server, go back there.
                                                if (refUrl.port === '5173') {
                                                    window.location.href = refUrl.origin + '/home.html';
                                                    return;
                                                }
                                            }
                                        } catch (_) {}
                                        window.location.href = 'http://localhost:5173/home.html';
                }
            });
        }
    });
</script>

<script>
    // Functional chat wiring: POST JSON to /get with optional meta + lightweight conversation history.
    document.addEventListener('DOMContentLoaded', function () {
        var input = document.getElementById('chat-input');
        var sendBtn = document.getElementById('chat-send');
        var log = document.getElementById('chat-log');

        if (!input || !sendBtn || !log) return;

        var history = [];
        var meta = (window.MEDGUARD_META && typeof window.MEDGUARD_META === 'object') ? window.MEDGUARD_META : {};

        function nowLabel() {
            try {
                return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch (_) {
                return '';
            }
        }

        function escapeHtml(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function appendUser(text) {
            var t = escapeHtml(text);
            var ts = nowLabel();
            var wrap = document.createElement('div');
            wrap.className = 'mg-row mg-row-user';
            wrap.innerHTML = "" +
                "<div class='mg-col mg-col-user'>" +
                    "<div class='bg-primary p-3 rounded-lg rounded-tr-none'>" +
                        "<p class='text-sm text-white'>" + t + "</p>" +
                    "</div>" +
                    "<span class='text-xs text-gray-500 dark:text-gray-400 mt-1'>" + ts + "</span>" +
                "</div>" +
                "<div class='w-8 h-8 rounded-full bg-primary/10 dark:bg-primary/20 flex items-center justify-center'>" +
                    "<span class='material-symbols-outlined text-gray-700 dark:text-gray-300'>person</span>" +
                "</div>";
            log.appendChild(wrap);
            log.scrollTop = log.scrollHeight;
        }

        function appendBot(text) {
            var t = escapeHtml(text);
            var ts = nowLabel();
            var wrap = document.createElement('div');
            wrap.className = 'mg-row mg-row-bot';
            wrap.innerHTML = "" +
                "<img alt='AI Assistant Avatar' class='w-8 h-8 rounded-full' src='https://lh3.googleusercontent.com/aida-public/AB6AXuD58a5UD08npEzMAZTBkCnx6s4GlnRgrDf96QEQVAYKZV209SCbDIETlwjlhZ9tfYzjefwyPsqoGvgIAY4zKFzaf_EuNu4nSu3WlGzP1ElF7dsYolWXKiaXm05S3lbDB_r-pTyMfo3OCVEQ-WH4zNMRPyAkCpEutWmfVmLNHBpXtL8FyP0zy7tgwTqHG5qxFpF_yG9W15ax70rkI2UvyzSOQm4Jvm6i2tL5NTu3jI4ny_4joMPeiaR842tMldIOW1ZVbRTFjWBM4SY'/>" +
                "<div class='mg-col mg-col-bot'>" +
                    "<div class='bg-primary/10 dark:bg-primary/20 p-3 rounded-lg rounded-tl-none'>" +
                        "<p class='text-sm text-gray-800 dark:text-gray-200'>" + t + "</p>" +
                    "</div>" +
                    "<span class='text-xs text-gray-500 dark:text-gray-400 mt-1'>" + ts + "</span>" +
                "</div>";
            log.appendChild(wrap);
            log.scrollTop = log.scrollHeight;
        }

        function appendTyping() {
            // A bot bubble with animated dots.
            var ts = nowLabel();
            var wrap = document.createElement('div');
            wrap.className = 'mg-row mg-row-bot';
            wrap.setAttribute('data-typing', '1');
            wrap.innerHTML = "" +
                "<img alt='AI Assistant Avatar' class='w-8 h-8 rounded-full' src='https://lh3.googleusercontent.com/aida-public/AB6AXuD58a5UD08npEzMAZTBkCnx6s4GlnRgrDf96QEQVAYKZV209SCbDIETlwjlhZ9tfYzjefwyPsqoGvgIAY4zKFzaf_EuNu4nSu3WlGzP1ElF7dsYolWXKiaXm05S3lbDB_r-pTyMfo3OCVEQ-WH4zNMRPyAkCpEutWmfVmLNHBpXtL8FyP0zy7tgwTqHG5qxFpF_yG9W15ax70rkI2UvyzSOQm4Jvm6i2tL5NTu3jI4ny_4joMPeiaR842tMldIOW1ZVbRTFjWBM4SY'/>" +
                "<div class='mg-col mg-col-bot'>" +
                    "<div class='bg-primary/10 dark:bg-primary/20 p-3 rounded-lg rounded-tl-none'>" +
                        "<div class='flex items-center gap-2'>" +
                            "<span class='mg-typing-dot bg-gray-700 dark:bg-gray-300'></span>" +
                            "<span class='mg-typing-dot bg-gray-700 dark:bg-gray-300'></span>" +
                            "<span class='mg-typing-dot bg-gray-700 dark:bg-gray-300'></span>" +
                            "<span class='sr-only'>Assistant is typing</span>" +
                        "</div>" +
                    "</div>" +
                    "<span class='text-xs text-gray-500 dark:text-gray-400 mt-1'>" + ts + "</span>" +
                "</div>";
            log.appendChild(wrap);
            log.scrollTop = log.scrollHeight;
            return wrap;
        }

        function removeTyping(el) {
            try {
                if (el && el.parentNode) el.parentNode.removeChild(el);
            } catch (_) {}
        }

        async function send() {
            var text = (input.value || '').trim();
            if (!text) return;
            input.value = '';
            appendUser(text);

            history.push({ role: 'user', content: text });

            var typingEl = appendTyping();

            sendBtn.disabled = true;
            try {
                var res = await fetch('/get', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ msg: text, history: history.slice(-20), meta: meta })
                });
                if (!res.ok) {
                    removeTyping(typingEl);
                    try {
                        var errData = await res.json();
                        var errAnswer = (errData && errData.answer) ? String(errData.answer) : '';
                        appendBot(errAnswer || 'Sorry — I ran into a problem while answering. Please try again in a moment.');
                    } catch (_) {
                        appendBot('Sorry — I ran into a problem while answering. Please try again in a moment.');
                    }
                    return;
                }
                var data = await res.json();
                var answer = (data && data.answer) ? String(data.answer) : "I don't know.";
                history.push({ role: 'assistant', content: answer });
                removeTyping(typingEl);
                appendBot(answer);
            } catch (e) {
                removeTyping(typingEl);
                appendBot('Sorry — I couldn\'t reach the chatbot service. Please make sure it\'s running, then try again.');
            } finally {
                sendBtn.disabled = false;
            }
        }

        sendBtn.addEventListener('click', send);
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                send();
            }
        });
    });
</script>